{% comment %}
  WhatsApp Order Confirmation Block
  Se inserta din√°micamente en la Order Status Page despu√©s del resumen del pedido
{% endcomment %}

<div id="whatsapp-confirmation-box"></div>
<div id="whatsapp-confirmation-overlay"></div>

<style>
  /* Modal Overlay */
  #whatsapp-confirmation-overlay {
    display: none !important;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background-color: rgba(0, 0, 0, 0.7) !important;
    z-index: 999999 !important;
    justify-content: center !important;
    align-items: center !important;
    animation: fadeIn 0.3s ease !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  #whatsapp-confirmation-overlay.show {
    display: flex !important;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes slideUp {
    from {
      transform: translateY(50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  #whatsapp-confirmation-box {
    margin: 0;
    padding: 0;
    width: 100%;
    display: none;
  }

  .whatsapp-confirmation-container {
    background-color: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 30px;
    margin: 20px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    position: relative;
    animation: slideUp 0.4s ease;
  }

  .whatsapp-confirmation-close {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
  }

  .whatsapp-confirmation-close:hover {
    background-color: #f0f0f0;
    color: #000;
  }

  .whatsapp-confirmation-title {
    font-family: "D-DIN", "DIN", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 18px;
    font-weight: 600;
    color: #000000;
    text-align: center;
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .whatsapp-confirmation-preview {
    background-color: #f5f5f5;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 20px;
    font-family: "D-DIN", "DIN", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 14px;
    color: #333333;
    line-height: 1.6;
    white-space: pre-wrap;
    max-height: 300px;
    overflow-y: auto;
  }

  .whatsapp-confirmation-button {
    display: block;
    width: 100%;
    padding: 15px 30px;
    background-color: #ffffff;
    color: #000000;
    border: 2px solid #000000;
    border-radius: 4px;
    font-family: "D-DIN", "DIN", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-align: center;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    box-sizing: border-box;
  }

  .whatsapp-confirmation-button:hover {
    background-color: #000000;
    color: #ffffff;
    text-decoration: none;
  }

  .whatsapp-confirmation-button:active {
    transform: scale(0.98);
  }

  .whatsapp-confirmation-button svg {
    width: 20px;
    height: 20px;
    vertical-align: middle;
    margin-right: 8px;
    display: inline-block;
  }

  /* Desktop: ancho autom√°tico */
  @media (min-width: 768px) {
    .whatsapp-confirmation-button {
      width: auto;
      min-width: 250px;
      margin: 0 auto;
      display: inline-block;
    }

    .whatsapp-confirmation-container {
      text-align: center;
    }
  }

  /* Mobile: ancho completo */
  @media (max-width: 767px) {
    .whatsapp-confirmation-container {
      padding: 20px 15px;
      margin: 15px 0;
    }

    .whatsapp-confirmation-title {
      font-size: 16px;
    }

    .whatsapp-confirmation-preview {
      font-size: 13px;
      padding: 12px;
    }

    .whatsapp-confirmation-button {
      font-size: 13px;
      padding: 12px 20px;
    }
  }
</style>

<script>
(function() {
  'use strict';

  // Funci√≥n para formatear el precio
  function formatPrice(price, currency) {
    if (!price && price !== 0) return 'N/A';
    
    // Si el precio viene en centavos (formato com√∫n de Shopify)
    var amount = price;
    if (typeof price === 'number' && price > 1000) {
      // Asumir que est√° en centavos si es un n√∫mero grande
      amount = price / 100;
    }
    
    // Formatear con 2 decimales
    var formatted = parseFloat(amount).toFixed(2);
    
    // Agregar s√≠mbolo de moneda si est√° disponible
    if (currency) {
      // Formato com√∫n: $XX.XX o XX.XX USD
      return formatted + ' ' + currency;
    }
    
    return formatted;
  }

  // Funci√≥n para construir el mensaje de WhatsApp
  function buildWhatsAppMessage(checkout) {
    if (!checkout || !checkout.order) {
      return '';
    }

    var order = checkout.order;
    var message = '¬°Hola! üëã Acabo de finalizar una compra.\n\n';
    
    // N√∫mero de pedido
    var orderNumber = order.order_number || order.name || 'N/A';
    message += '* N√∫mero de Pedido: ' + orderNumber + '\n';
    
    // Nombre del cliente
    var customerName = 'Cliente';
    if (order.customer) {
      var firstName = order.customer.first_name || '';
      var lastName = order.customer.last_name || '';
      customerName = (firstName + ' ' + lastName).trim() || 'Cliente';
    }
    message += '* Cliente: ' + customerName + '\n';
    
    // Total pagado
    var totalPrice = 'N/A';
    if (order.total_price_set && order.total_price_set.shop_money) {
      // Formato preferido de Shopify
      var amount = parseFloat(order.total_price_set.shop_money.amount);
      var currency = order.total_price_set.shop_money.currency_code || order.currency || '';
      totalPrice = amount.toFixed(2) + ' ' + currency;
    } else if (order.total_price) {
      // Formato alternativo
      totalPrice = formatPrice(order.total_price, order.currency);
    }
    message += '* Total Pagado: ' + totalPrice + '\n\n';
    
    // Detalle de art√≠culos
    message += 'Detalle de los art√≠culos:\n';
    if (order.line_items && order.line_items.length > 0) {
      order.line_items.forEach(function(item, index) {
        var itemName = item.title || item.name || item.product_title || 'Producto';
        
        // Manejar variantes
        if (item.variant_title && item.variant_title !== 'Default Title') {
          itemName += ' - ' + item.variant_title;
        }
        
        var quantity = item.quantity || 1;
        var itemPrice = '';
        var currency = order.currency || '';
        
        // Intentar obtener el precio formateado
        if (item.price_set && item.price_set.shop_money) {
          var amount = parseFloat(item.price_set.shop_money.amount);
          currency = item.price_set.shop_money.currency_code || currency;
          itemPrice = amount.toFixed(2) + ' ' + currency;
        } else if (item.price) {
          itemPrice = formatPrice(item.price, currency);
        }
        
        message += (index + 1) + '. ' + itemName + ' (x' + quantity + ')';
        if (itemPrice) {
          message += ' - ' + itemPrice;
        }
        message += '\n';
      });
    } else {
      message += 'No hay items disponibles\n';
    }
    
    message += '\n';
    
    // M√©todo de env√≠o
    var shippingMethod = 'No especificado';
    if (order.shipping_line && order.shipping_line.title) {
      shippingMethod = order.shipping_line.title;
    } else if (order.shipping_address) {
      shippingMethod = 'Env√≠o est√°ndar';
    }
    message += '* M√©todo de Env√≠o: ' + shippingMethod + '\n';
    
    // M√©todo de pago
    var paymentMethod = 'No especificado';
    if (order.transactions && order.transactions.length > 0) {
      var transaction = order.transactions[0];
      if (transaction.gateway) {
        paymentMethod = transaction.gateway;
        // Limpiar el nombre del gateway (remover guiones bajos y capitalizar)
        paymentMethod = paymentMethod.replace(/_/g, ' ').replace(/\b\w/g, function(l) {
          return l.toUpperCase();
        });
      } else if (transaction.payment_details && transaction.payment_details.credit_card_company) {
        // Alternativa: usar la compa√±√≠a de la tarjeta
        paymentMethod = transaction.payment_details.credit_card_company;
      } else if (transaction.kind) {
        // Alternativa: usar el tipo de transacci√≥n
        paymentMethod = transaction.kind.replace(/_/g, ' ').replace(/\b\w/g, function(l) {
          return l.toUpperCase();
        });
      }
    } else if (order.payment_gateway_names && order.payment_gateway_names.length > 0) {
      // Alternativa: usar payment_gateway_names
      paymentMethod = order.payment_gateway_names[0];
    }
    message += '* M√©todo de Pago: ' + paymentMethod + '\n\n';
    
    message += 'Ya estoy lista para concretar el env√≠o.';
    
    return message;
  }

  // Funci√≥n para extraer datos del pedido desde el DOM
  function extractOrderDataFromDOM() {
    console.log('[WhatsApp] Intentando extraer datos del pedido desde el DOM...');
    
    var orderData = {
      order_number: null,
      customer_name: null,
      total_price: null,
      line_items: [],
      shipping_method: null,
      payment_method: null
    };

    // Buscar n√∫mero de pedido
    var orderNumberSelectors = [
      '[data-order-number]',
      '.order-number',
      '[class*="order-number"]',
      '[id*="order-number"]',
      'h1, h2, h3, h4'
    ];
    
    for (var i = 0; i < orderNumberSelectors.length; i++) {
      var elements = document.querySelectorAll(orderNumberSelectors[i]);
      for (var j = 0; j < elements.length; j++) {
        var text = elements[j].textContent || '';
        // Buscar patrones como "#1234" o "Order #1234"
        var match = text.match(/#?\s*(\d+)/);
        if (match && match[1]) {
          orderData.order_number = match[1];
          console.log('[WhatsApp] N√∫mero de pedido encontrado en DOM:', orderData.order_number);
          break;
        }
      }
      if (orderData.order_number) break;
    }

    // Buscar total
    var totalSelectors = [
      '[data-total]',
      '.order-total',
      '[class*="total"]',
      '[class*="price"]'
    ];
    
    for (var i = 0; i < totalSelectors.length; i++) {
      var elements = document.querySelectorAll(totalSelectors[i]);
      for (var j = 0; j < elements.length; j++) {
        var text = elements[j].textContent || '';
        // Buscar patrones de precio como "$123.45" o "123.45 USD"
        var match = text.match(/[\$]?\s*(\d+[.,]\d{2})/);
        if (match && match[1]) {
          orderData.total_price = match[1].replace(',', '.');
          console.log('[WhatsApp] Total encontrado en DOM:', orderData.total_price);
          break;
        }
      }
      if (orderData.total_price) break;
    }

    // Buscar items en tablas
    var tables = document.querySelectorAll('table');
    for (var i = 0; i < tables.length; i++) {
      var rows = tables[i].querySelectorAll('tr');
      for (var j = 0; j < rows.length; j++) {
        var cells = rows[j].querySelectorAll('td, th');
        if (cells.length >= 2) {
          var itemName = cells[0].textContent.trim();
          var quantity = cells[cells.length - 2] ? cells[cells.length - 2].textContent.trim() : '1';
          if (itemName && !itemName.toLowerCase().includes('total') && !itemName.toLowerCase().includes('subtotal')) {
            orderData.line_items.push({
              title: itemName,
              quantity: parseInt(quantity) || 1
            });
          }
        }
      }
      if (orderData.line_items.length > 0) {
        console.log('[WhatsApp] Items encontrados en DOM:', orderData.line_items.length);
        break;
      }
    }

    return orderData;
  }

  // Funci√≥n para obtener datos del pedido desde diferentes fuentes
  function getOrderData() {
    var orderData = null;

    // M√©todo 1: Shopify.checkout.order (preferido)
    if (window.Shopify && window.Shopify.checkout && window.Shopify.checkout.order) {
      console.log('[WhatsApp] Obteniendo datos desde Shopify.checkout.order');
      orderData = { order: window.Shopify.checkout.order };
    }
    // M√©todo 2: Shopify.checkout directamente
    else if (window.Shopify && window.Shopify.checkout) {
      console.log('[WhatsApp] Obteniendo datos desde Shopify.checkout');
      orderData = window.Shopify.checkout;
    }
    // M√©todo 3: window.checkout (alternativa)
    else if (window.checkout && window.checkout.order) {
      console.log('[WhatsApp] Obteniendo datos desde window.checkout');
      orderData = window.checkout;
    }
    // M√©todo 4: Extraer desde el DOM
    else {
      console.log('[WhatsApp] Intentando obtener datos desde el DOM');
      var domData = extractOrderDataFromDOM();
      if (domData.order_number) {
        // Convertir datos del DOM al formato esperado
        orderData = {
          order: {
            order_number: domData.order_number,
            name: domData.order_number,
            customer: {
              first_name: domData.customer_name || '',
              last_name: ''
            },
            line_items: domData.line_items,
            total_price: domData.total_price ? parseFloat(domData.total_price) * 100 : 0,
            shipping_line: domData.shipping_method ? { title: domData.shipping_method } : null,
            transactions: domData.payment_method ? [{ gateway: domData.payment_method }] : []
          }
        };
        console.log('[WhatsApp] Datos extra√≠dos del DOM:', orderData);
      }
    }

    return orderData;
  }

  // Funci√≥n para insertar el bloque de WhatsApp
  function insertWhatsAppBlock() {
    console.log('[WhatsApp] insertWhatsAppBlock llamado');
    
    // Verificar si el modal ya existe y est√° visible
    var existingOverlay = document.getElementById('whatsapp-confirmation-overlay');
    if (existingOverlay && existingOverlay.classList.contains('show')) {
      console.log('[WhatsApp] El modal ya est√° visible');
      return;
    }

    // Intentar obtener datos del pedido desde diferentes fuentes
    console.log('[WhatsApp] Verificando fuentes de datos...');
    console.log('[WhatsApp] window.Shopify existe:', typeof window.Shopify !== 'undefined');
    
    var checkout = getOrderData();
    var message = '';
    
    if (checkout) {
      console.log('[WhatsApp] Datos del pedido obtenidos, construyendo mensaje...');
      message = buildWhatsAppMessage(checkout);
    }
    
    // Si no hay mensaje, crear uno gen√©rico
    if (!message) {
      console.log('[WhatsApp] No se pudieron obtener datos completos, creando mensaje gen√©rico...');
      message = '¬°Hola! üëã Acabo de finalizar una compra en tu tienda.\n\n';
      message += 'Me gustar√≠a confirmar los detalles del pedido y coordinar el env√≠o.\n\n';
      message += 'Por favor, comparte conmigo la informaci√≥n del pedido.';
    }
    
    console.log('[WhatsApp] Mensaje construido exitosamente, longitud:', message.length);

    // Codificar el mensaje para URL
    var encodedMessage = encodeURIComponent(message);
    var whatsappUrl = 'https://wa.me/584122150171?text=' + encodedMessage;

    // Funci√≥n para escapar HTML
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Codificar el mensaje para URL
    var encodedMessage = encodeURIComponent(message);
    var whatsappUrl = 'https://wa.me/584122150171?text=' + encodedMessage;

    // Funci√≥n para escapar HTML
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Crear el HTML del modal
    var html = '<div class="whatsapp-confirmation-container">';
    html += '<button class="whatsapp-confirmation-close" onclick="this.closest(\'#whatsapp-confirmation-overlay\').classList.remove(\'show\')" aria-label="Cerrar">&times;</button>';
    html += '<h3 class="whatsapp-confirmation-title">Confirmar Pedido por WhatsApp</h3>';
    html += '<div class="whatsapp-confirmation-preview">' + escapeHtml(message).replace(/\n/g, '<br>') + '</div>';
    html += '<a href="' + whatsappUrl + '" target="_blank" rel="noopener noreferrer" class="whatsapp-confirmation-button" onclick="setTimeout(function(){document.getElementById(\'whatsapp-confirmation-overlay\').classList.remove(\'show\')}, 500);">';
    html += '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" fill="currentColor">';
    html += '<path d="M4.868,43.303l2.694-9.835C5.9,30.59,5.026,27.324,5.027,23.979C5.032,13.514,13.548,5,24.014,5c5.079,0.002,9.845,1.979,13.43,5.566c3.584,3.588,5.558,8.356,5.556,13.428c-0.004,10.465-8.522,18.98-18.986,18.98c-0.001,0,0,0,0,0h-0.008c-3.177-0.001-6.3-0.798-9.073-2.311L4.868,43.303z"></path>';
    html += '<path fill="#40c351" d="M35.176,12.832c-2.98-2.982-6.941-4.625-11.157-4.626c-8.704,0-15.783,7.076-15.787,15.774c-0.001,2.981,0.833,5.883,2.413,8.396l0.376,0.597l-1.595,5.821l5.973-1.566l0.577,0.342c2.422,1.438,5.2,2.198,8.032,2.199h0.006c8.698,0,15.777-7.077,15.78-15.776C39.795,19.778,38.156,15.814,35.176,12.832z"></path>';
    html += '<path fill="#fff" fill-rule="evenodd" d="M19.268,16.045c-0.355-0.79-0.729-0.806-1.068-0.82c-0.277-0.012-0.593-0.011-0.909-0.011c-0.316,0-0.83,0.119-1.265,0.594c-0.435,0.475-1.661,1.622-1.661,3.956c0,2.334,1.7,4.59,1.937,4.906c0.237,0.316,3.282,5.259,8.104,7.161c4.007,1.58,4.823,1.266,5.693,1.187c0.87-0.079,2.807-1.147,3.202-2.255c0.395-1.108,0.395-2.057,0.277-2.255c-0.119-0.198-0.435-0.316-0.909-0.554s-2.807-1.385-3.242-1.543c-0.435-0.158-0.751-0.237-1.068,0.238c-0.316,0.474-1.225,1.543-1.502,1.859c-0.277,0.317-0.554,0.357-1.028,0.119c-0.474-0.238-2.002-0.738-3.815-2.354c-1.41-1.257-2.362-2.81-2.639-3.285c-0.277-0.474-0.03-0.731,0.208-0.968c0.213-0.213,0.474-0.554,0.712-0.831c0.237-0.277,0.316-0.475,0.474-0.791c0.158-0.317,0.079-0.594-0.04-0.831C20.612,19.329,19.69,16.983,19.268,16.045z" clip-rule="evenodd"></path>';
    html += '</svg>';
    html += 'Enviar por WhatsApp';
    html += '</a>';
    html += '</div>';

    // Buscar o crear el overlay
    var overlay = document.getElementById('whatsapp-confirmation-overlay');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = 'whatsapp-confirmation-overlay';
      document.body.appendChild(overlay);
    }
    
    // Insertar el contenido del modal
    overlay.innerHTML = html;
    
    // Cerrar al hacer click fuera del modal
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) {
        overlay.classList.remove('show');
      }
    });
    
    console.log('[WhatsApp] ‚úÖ Modal insertado exitosamente en el DOM');
  }

  // Funci√≥n para buscar el resumen del pedido e insertar el contenedor
  function findOrderSummaryAndInsert() {
    console.log('[WhatsApp] findOrderSummaryAndInsert llamado');
    
    // Verificar si el contenedor ya existe
    var existingBox = document.getElementById('whatsapp-confirmation-box');
    if (existingBox && existingBox.innerHTML.trim() !== '') {
      console.log('[WhatsApp] El contenedor ya existe y tiene contenido');
      return; // Ya est√° insertado y tiene contenido
    }

    // Buscar elementos comunes de Shopify Order Status Page
    var selectors = [
      '[data-order-status]',
      '[data-order-summary]',
      '.order-summary',
      '.order__summary',
      '.order-status',
      '.order-status__summary',
      '[class*="order-summary"]',
      '[class*="order-status"]',
      'main',
      '.main-content',
      '.content',
      '[role="main"]',
      '.checkout',
      '.checkout__main'
    ];

    var targetElement = null;
    
    // Primero buscar elementos espec√≠ficos de Shopify
    for (var i = 0; i < selectors.length; i++) {
      var elements = document.querySelectorAll(selectors[i]);
      if (elements.length > 0) {
        // Buscar el que tenga contenido relacionado con el pedido
        for (var j = 0; j < elements.length; j++) {
          var text = (elements[j].textContent || '').toLowerCase();
          if (text.includes('order') || text.includes('pedido') || text.includes('total') || 
              text.includes('thank you') || text.includes('gracias') || 
              text.includes('order number') || text.includes('n√∫mero de pedido')) {
            targetElement = elements[j];
            break;
          }
        }
        if (targetElement) break;
      }
    }

    // Si no encontramos un elemento espec√≠fico, buscar por estructura com√∫n
    if (!targetElement) {
      // Buscar elementos que contengan informaci√≥n de pedido
      var allSections = document.querySelectorAll('section, div[class*="section"], div[class*="container"]');
      for (var k = 0; k < allSections.length; k++) {
        var sectionText = (allSections[k].textContent || '').toLowerCase();
        if ((sectionText.includes('order') || sectionText.includes('pedido')) && 
            (sectionText.includes('total') || sectionText.includes('items'))) {
          targetElement = allSections[k];
          break;
        }
      }
    }

    // Si a√∫n no encontramos, usar contenedores principales
    if (!targetElement) {
      targetElement = document.querySelector('main') || 
                     document.querySelector('.main-content') || 
                     document.querySelector('.content') ||
                     document.querySelector('.container') ||
                     document.body;
    }

    // Si el contenedor ya existe pero est√° vac√≠o, solo intentar insertar contenido
    if (existingBox) {
      console.log('[WhatsApp] Contenedor existe pero est√° vac√≠o, intentando insertar contenido');
      insertWhatsAppBlock();
      return;
    }

    console.log('[WhatsApp] Creando nuevo contenedor...');
    // Crear el contenedor
    var box = document.createElement('div');
    box.id = 'whatsapp-confirmation-box';
    
    // Insertar despu√©s del elemento objetivo
    if (targetElement && targetElement.parentNode) {
      console.log('[WhatsApp] Insertando contenedor despu√©s del elemento objetivo');
      // Intentar insertar despu√©s del elemento
      if (targetElement.nextSibling) {
        targetElement.parentNode.insertBefore(box, targetElement.nextSibling);
      } else {
        targetElement.parentNode.appendChild(box);
      }
    } else {
      console.log('[WhatsApp] Insertando contenedor al final del body (√∫ltimo recurso)');
      // Como √∫ltimo recurso, insertar al final del body
      document.body.appendChild(box);
    }

    console.log('[WhatsApp] Contenedor creado, intentando insertar contenido...');
    // Intentar insertar el contenido
    insertWhatsAppBlock();
  }

  // Funci√≥n para verificar si estamos en la p√°gina de Agradecimiento (Thank You)
  function isThankYouPage() {
    var path = window.location.pathname.toLowerCase();
    var href = window.location.href.toLowerCase();
    var title = document.title.toLowerCase();
    
    // Verificar por URL - p√°ginas de agradecimiento de Shopify
    var isThankYou = path.includes('/thank_you') || 
                     path.includes('/thank-you') ||
                     path.includes('/checkouts/') ||
                     href.includes('thank_you') ||
                     href.includes('thank-you') ||
                     href.includes('order_status') ||
                     title.includes('thank you') ||
                     title.includes('agradecimiento') ||
                     title.includes('order confirmation') ||
                     document.querySelector('[data-order-status]') ||
                     document.querySelector('.order-status') ||
                     document.querySelector('[class*="order-status"]') ||
                     document.querySelector('[class*="thank-you"]') ||
                     document.querySelector('[class*="order-confirmation"]') ||
                     document.querySelector('[class*="checkout"]') ||
                     // Buscar texto com√∫n en p√°ginas de agradecimiento
                     (document.body && (
                       document.body.textContent.includes('Thank you') ||
                       document.body.textContent.includes('Gracias') ||
                       document.body.textContent.includes('Order confirmation') ||
                       document.body.textContent.includes('Confirmaci√≥n de pedido')
                     ));
    
    console.log('[WhatsApp] Verificando p√°gina de Agradecimiento - Path:', path, 'Is Thank You Page:', isThankYou);
    return isThankYou;
  }

  // Esperar a que el DOM est√© listo y Shopify.checkout est√© disponible
  function initWhatsAppConfirmation() {
    console.log('[WhatsApp] Inicializando...');
    console.log('[WhatsApp] window.Shopify existe:', typeof window.Shopify !== 'undefined');
    console.log('[WhatsApp] window.Shopify.checkout existe:', typeof window.Shopify !== 'undefined' && !!window.Shopify.checkout);
    
    if (typeof window.Shopify !== 'undefined' && window.Shopify.checkout) {
      console.log('[WhatsApp] Shopify.checkout:', window.Shopify.checkout);
      console.log('[WhatsApp] Shopify.checkout.order:', window.Shopify.checkout.order);
    }

    // Verificar si estamos en la p√°gina de Agradecimiento
    var isThankYou = isThankYouPage();
    
    // Si no estamos en la p√°gina de Agradecimiento, no hacer nada
    if (!isThankYou) {
      console.log('[WhatsApp] No es p√°gina de Agradecimiento, saliendo');
      return;
    }

    console.log('[WhatsApp] ‚úÖ Estamos en la p√°gina de Agradecimiento!');

    console.log('[WhatsApp] Continuando con la inicializaci√≥n...');

    // Esperar a que el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('[WhatsApp] DOM cargado');
        findOrderSummaryAndInsert();
      });
    } else {
      console.log('[WhatsApp] DOM ya est√° listo');
      findOrderSummaryAndInsert();
    }

    // Funci√≥n para mostrar el modal (se ejecuta despu√©s de 3 segundos)
    function showModalAfterDelay() {
      console.log('[WhatsApp] ‚è∞ Mostrando modal despu√©s de 3 segundos...');
      
      // Insertar el bloque si no existe
      insertWhatsAppBlock();
      
      // Buscar o crear el overlay
      var overlay = document.getElementById('whatsapp-confirmation-overlay');
      
      if (!overlay) {
        console.log('[WhatsApp] Creando overlay...');
        // Crear el overlay si no existe
        overlay = document.createElement('div');
        overlay.id = 'whatsapp-confirmation-overlay';
        document.body.appendChild(overlay);
      }
      
      // Mostrar el overlay
      setTimeout(function() {
        if (overlay) {
          overlay.classList.add('show');
          console.log('[WhatsApp] ‚úÖ Modal mostrado exitosamente!');
          
          // Verificar que realmente se muestra
          setTimeout(function() {
            var isVisible = overlay.classList.contains('show') && 
                           window.getComputedStyle(overlay).display !== 'none';
            console.log('[WhatsApp] Modal visible:', isVisible);
            if (!isVisible) {
              console.error('[WhatsApp] ‚ö†Ô∏è El modal no es visible! Verificar CSS.');
            }
          }, 200);
        } else {
          console.error('[WhatsApp] ‚ö†Ô∏è ERROR: No se pudo encontrar el overlay');
        }
      }, 100);
    }

    // Ejecutar despu√©s de 3 segundos - GARANTIZADO
    console.log('[WhatsApp] ‚è±Ô∏è Programando modal para aparecer en 3 segundos...');
    setTimeout(showModalAfterDelay, 3000);
    
    // Backup: tambi√©n intentar despu√©s de 5 segundos por si acaso
    setTimeout(function() {
      var overlay = document.getElementById('whatsapp-confirmation-overlay');
      if (overlay && !overlay.classList.contains('show')) {
        console.log('[WhatsApp] Backup: Mostrando modal despu√©s de 5 segundos...');
        overlay.classList.add('show');
      }
    }, 5000);

    // Intentar cada segundo durante 15 segundos por si el objeto se carga m√°s tarde
    var attempts = 0;
    var maxAttempts = 15;
    var interval = setInterval(function() {
      attempts++;
      console.log('[WhatsApp] Intento peri√≥dico #' + attempts);
      
      if (typeof window.Shopify !== 'undefined' && window.Shopify.checkout) {
        console.log('[WhatsApp] Shopify.checkout encontrado en intento #' + attempts);
        if (window.Shopify.checkout.order) {
          console.log('[WhatsApp] Shopify.checkout.order encontrado!');
          findOrderSummaryAndInsert();
          insertWhatsAppBlock();
          clearInterval(interval);
        } else {
          console.log('[WhatsApp] Shopify.checkout existe pero order no est√° disponible a√∫n');
        }
      } else if (attempts >= maxAttempts) {
        console.log('[WhatsApp] M√°ximo de intentos alcanzado. Intentando insertar de todas formas...');
        clearInterval(interval);
        // Intentar insertar de todas formas si estamos en p√°gina de agradecimiento
        if (isThankYouPage()) {
          findOrderSummaryAndInsert();
        }
      }
    }, 1000);
  }

  // Iniciar cuando el script se carga
  console.log('[WhatsApp] Script cargado, document.readyState:', document.readyState);
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[WhatsApp] DOMContentLoaded event fired');
      initWhatsAppConfirmation();
    });
  } else {
    console.log('[WhatsApp] DOM ya est√° listo, iniciando inmediatamente');
    initWhatsAppConfirmation();
  }

  // Tambi√©n iniciar despu√©s de un peque√±o delay como backup
  setTimeout(function() {
    console.log('[WhatsApp] Backup init despu√©s de 100ms');
    initWhatsAppConfirmation();
  }, 100);
})();
</script>

