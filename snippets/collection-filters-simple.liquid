{% comment %}
  Filtros simplificados: 4 dropdowns horizontales
  - Categorías
  - Color
  - Talla (usando metafield custom.talla_estandar)
  - Precio
{% endcomment %}

<div class="collection-filters-simple">
  <div class="container container-v1">
    <div class="row">
      <div class="col-12">
        <div class="filters-row d-flex flex-wrap">
          
          {% comment %} Filtro de Categorías {% endcomment %}
          <div class="filter-dropdown-wrapper">
            <select class="filter-dropdown" id="filter-category" data-filter="category">
              <option value="">CATEGORÍAS</option>
              {% if settings.widget_cate_menu != blank %}
                {% for link in linklists[settings.widget_cate_menu].links %}
                  <option value="{{ link.url }}" {% if collection.url == link.url %}selected{% endif %}>
                    {{ link.title | split: '[' | first }}
                  </option>
                {% endfor %}
              {% else %}
                {% comment %} Fallback: usar todas las colecciones principales {% endcomment %}
                {% for collection_item in collections %}
                  {% unless collection_item.handle == 'all' or collection_item.handle == 'frontpage' %}
                    <option value="{{ collection_item.url }}" {% if collection.url == collection_item.url %}selected{% endif %}>
                      {{ collection_item.title }}
                    </option>
                  {% endunless %}
                {% endfor %}
              {% endif %}
            </select>
          </div>

          {% comment %} Filtro de Color - Dinámico desde productos reales {% endcomment %}
          <div class="filter-dropdown-wrapper">
            <select class="filter-dropdown" id="filter-color" data-filter="color">
              <option value="">COLOR</option>
              {% comment %} Recopilar colores únicos de los productos de la colección {% endcomment %}
              {% assign unique_colors = '' | split: ',' %}
              {% assign color_map = '' | split: ',' %}
              
              {% for product in collection.products %}
                {% comment %} Buscar la opción "Color" o "Colour" en las opciones del producto {% endcomment %}
                {% assign color_option_index = -1 %}
                {% for option in product.options %}
                  {% assign option_lower = option | downcase %}
                  {% if option_lower == 'color' or option_lower == 'colour' %}
                    {% assign color_option_index = forloop.index0 %}
                    {% break %}
                  {% endif %}
                {% endfor %}
                
                {% comment %} Si se encontró la opción de color, extraer valores de variantes {% endcomment %}
                {% if color_option_index >= 0 %}
                  {% for variant in product.variants %}
                    {% if color_option_index == 0 and variant.option1 != blank %}
                      {% assign color_name = variant.option1 | strip %}
                      {% assign color_handle = color_name | handleize %}
                      {% unless unique_colors contains color_handle %}
                        {% assign unique_colors = unique_colors | push: color_handle %}
                        {% assign color_map = color_map | push: color_name %}
                      {% endunless %}
                    {% elsif color_option_index == 1 and variant.option2 != blank %}
                      {% assign color_name = variant.option2 | strip %}
                      {% assign color_handle = color_name | handleize %}
                      {% unless unique_colors contains color_handle %}
                        {% assign unique_colors = unique_colors | push: color_handle %}
                        {% assign color_map = color_map | push: color_name %}
                      {% endunless %}
                    {% elsif color_option_index == 2 and variant.option3 != blank %}
                      {% assign color_name = variant.option3 | strip %}
                      {% assign color_handle = color_name | handleize %}
                      {% unless unique_colors contains color_handle %}
                        {% assign unique_colors = unique_colors | push: color_handle %}
                        {% assign color_map = color_map | push: color_name %}
                      {% endunless %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                
                {% comment %} También buscar en tags del producto como fallback {% endcomment %}
                {% for tag in product.tags %}
                  {% assign tag_lower = tag | downcase %}
                  {% if tag_lower contains 'color' or tag_lower contains 'colour' %}
                    {% assign color_name = tag | strip %}
                    {% assign color_handle = color_name | handleize %}
                    {% unless unique_colors contains color_handle %}
                      {% assign unique_colors = unique_colors | push: color_handle %}
                      {% assign color_map = color_map | push: color_name %}
                    {% endunless %}
                  {% endif %}
                {% endfor %}
              {% endfor %}
              
              {% comment %} Si no se encontraron colores dinámicos, usar tags de configuración como fallback {% endcomment %}
              {% if unique_colors.size == 0 %}
                {% assign tags = settings.shop_by_color_list_tags | split: ',' %}
                {% for t in tags %}
                  {% assign tag = t | strip %}
                  {% if tag != blank %}
                    {% assign tag_value = tag | handleize %}
                    <option value="{{ tag_value | split: '|' | first }}" {% if current_tags contains tag %}selected{% endif %}>
                      {{ tag }}
                    </option>
                  {% endif %}
                {% endfor %}
              {% else %}
                {% comment %} Mostrar colores encontrados dinámicamente {% endcomment %}
                {% for color_handle in unique_colors %}
                  {% assign color_index = forloop.index0 %}
                  {% assign color_name = color_map[color_index] %}
                  <option value="{{ color_handle }}" {% if current_tags contains color_handle %}selected{% endif %}>
                    {{ color_name }}
                  </option>
                {% endfor %}
              {% endif %}
            </select>
          </div>

          {% comment %} Filtro de Talla (usando metafield custom.talla_estandar) {% endcomment %}
          <div class="filter-dropdown-wrapper">
            <select class="filter-dropdown" id="filter-size" data-filter="size">
              <option value="">TALLA</option>
              {% comment %} Extraer tallas desde metafield custom.talla_estandar de los productos reales {% endcomment %}
              {% assign unique_sizes = '' | split: ',' %}
              {% assign size_map = '' | split: ',' %}
              
              {% for product in collection.products %}
                {% for variant in product.variants %}
                  {% if variant.metafields.custom.talla_estandar != blank %}
                    {% assign size_value = variant.metafields.custom.talla_estandar | strip %}
                    {% if size_value != blank %}
                      {% assign size_handle = size_value | handleize %}
                      {% unless unique_sizes contains size_handle %}
                        {% assign unique_sizes = unique_sizes | push: size_handle %}
                        {% assign size_map = size_map | push: size_value %}
                      {% endunless %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
              {% endfor %}
              
              {% comment %} Si no hay metafields, usar tags como fallback {% endcomment %}
              {% if unique_sizes.size == 0 %}
                {% assign tags = settings.shop_by_size_list_tags | split: ',' %}
                {% for t in tags %}
                  {% assign tag = t | strip %}
                  {% if tag != blank %}
                    {% assign tag_value = tag | handleize %}
                    <option value="{{ tag_value | split: '|' | first }}" {% if current_tags contains tag %}selected{% endif %}>
                      {{ tag }}
                    </option>
                  {% endif %}
                {% endfor %}
              {% else %}
                {% comment %} Ordenar tallas numéricamente si es posible {% endcomment %}
                {% assign sorted_sizes = '' | split: ',' %}
                {% assign sorted_map = '' | split: ',' %}
                {% for size_handle in unique_sizes %}
                  {% assign size_index = forloop.index0 %}
                  {% assign size_name = size_map[size_index] %}
                  {% assign sorted_sizes = sorted_sizes | push: size_handle %}
                  {% assign sorted_map = sorted_map | push: size_name %}
                {% endfor %}
                
                {% comment %} Mostrar tallas encontradas {% endcomment %}
                {% for size_handle in sorted_sizes %}
                  {% assign size_index = forloop.index0 %}
                  {% assign size_name = sorted_map[size_index] %}
                  <option value="{{ size_handle }}" {% if current_tags contains size_handle %}selected{% endif %}>
                    {{ size_name }}
                  </option>
                {% endfor %}
              {% endif %}
            </select>
          </div>

          {% comment %} Filtro de Precio - Rangos fijos: 0-50, 50-150, 150+ {% endcomment %}
          <div class="filter-dropdown-wrapper">
            <select class="filter-dropdown" id="filter-price" data-filter="price">
              <option value="">PRECIO</option>
              <option value="0-50" {% if current_tags contains 'price-0-50' or current_tags contains '0-50' %}selected{% endif %}>0 - 50</option>
              <option value="50-150" {% if current_tags contains 'price-50-150' or current_tags contains '50-150' %}selected{% endif %}>50 - 150</option>
              <option value="150+" {% if current_tags contains 'price-150+' or current_tags contains '150+' %}selected{% endif %}>150+</option>
            </select>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .collection-filters-simple {
    margin: 20px 0;
  padding: 0;
  }
  
  .filters-row {
    gap: 15px;
    margin-bottom: 0;
  }
  
  .filter-dropdown-wrapper {
    flex: 1;
    min-width: 150px;
  }
  
  .filter-dropdown {
    width: 100%;
    padding: 12px 40px 12px 15px;
    border: 1px solid #000;
    background: #fff;
    font-size: 14px;
    font-weight: 400;
    color: #000;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23000' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .filter-dropdown:hover {
    border-color: #333;
  }
  
  .filter-dropdown:focus {
    outline: none;
    border-color: #000;
  }
  
  /* Responsive */
  @media (max-width: 991px) {
    .filters-row {
      gap: 10px;
    }
    
    .filter-dropdown-wrapper {
      flex: 0 0 calc(50% - 5px);
      min-width: calc(50% - 5px);
      max-width: calc(50% - 5px);
    }
    
    .filter-dropdown {
      font-size: 13px;
      padding: 10px 35px 10px 12px;
    }
  }
  
  @media (max-width: 575px) {
    .collection-filters-simple {
      margin: 15px 0;
    }
    
    .filters-row {
      gap: 10px;
    }
    
    .filter-dropdown-wrapper {
      flex: 0 0 100%;
      min-width: 100%;
      max-width: 100%;
    }
    
    .filter-dropdown {
      font-size: 13px;
      padding: 10px 35px 10px 12px;
    }
  }
</style>

<script>
  (function() {
    // Inicializar filtros cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFilters);
    } else {
      initFilters();
    }
    
    function initFilters() {
      const filterDropdowns = document.querySelectorAll('.filter-dropdown');
      
      filterDropdowns.forEach(function(dropdown) {
        dropdown.addEventListener('change', function() {
          applyFilters();
        });
      });
      
      // Restaurar valores desde URL si existen
      restoreFiltersFromURL();
    }
    
    function restoreFiltersFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const constraint = urlParams.get('constraint');
      
      if (constraint) {
        const tags = constraint.split('+');
        const colorFilter = document.getElementById('filter-color');
        const sizeFilter = document.getElementById('filter-size');
        const priceFilter = document.getElementById('filter-price');
        
        tags.forEach(function(tag) {
          const decodedTag = decodeURIComponent(tag);
          
          // Manejar rangos de precio
          if (decodedTag === 'price-0-50' && priceFilter) {
            priceFilter.value = '0-50';
          } else if (decodedTag === 'price-50-150' && priceFilter) {
            priceFilter.value = '50-150';
          } else if (decodedTag === 'price-150+' && priceFilter) {
            priceFilter.value = '150+';
          }
          // Intentar asignar a filtros de color y talla
          else if (colorFilter && colorFilter.querySelector('option[value="' + decodedTag + '"]')) {
            colorFilter.value = decodedTag;
          } else if (sizeFilter && sizeFilter.querySelector('option[value="' + decodedTag + '"]')) {
            sizeFilter.value = decodedTag;
          }
        });
      }
    }
    
    function applyFilters() {
      // Obtener valores de los filtros
      const categoryFilter = document.getElementById('filter-category');
      const colorFilter = document.getElementById('filter-color');
      const sizeFilter = document.getElementById('filter-size');
      const priceFilter = document.getElementById('filter-price');
      
      // Si se selecciona una categoría, redirigir directamente
      if (categoryFilter && categoryFilter.value) {
        window.location.href = categoryFilter.value;
        return;
      }
      
      // Construir array de tags para otros filtros
      const tags = [];
      
      if (colorFilter && colorFilter.value) {
        tags.push(colorFilter.value);
      }
      
      if (sizeFilter && sizeFilter.value) {
        tags.push(sizeFilter.value);
      }
      
      // Manejar filtro de precio con rangos
      if (priceFilter && priceFilter.value) {
        // Convertir rango de precio a tag para filtrado
        const priceValue = priceFilter.value;
        if (priceValue === '0-50') {
          tags.push('price-0-50');
        } else if (priceValue === '50-150') {
          tags.push('price-50-150');
        } else if (priceValue === '150+') {
          tags.push('price-150+');
        } else {
          tags.push(priceValue);
        }
      }
      
      // Construir URL
      let newUrl = window.location.pathname;
      const urlParams = new URLSearchParams();
      
      if (tags.length > 0) {
        urlParams.set('constraint', tags.join('+'));
      }
      
      // Mantener parámetros de ordenamiento
      const currentParams = new URLSearchParams(window.location.search);
      if (currentParams.get('sort_by')) {
        urlParams.set('sort_by', currentParams.get('sort_by'));
      }
      
      const queryString = urlParams.toString();
      if (queryString) {
        newUrl += '?' + queryString;
      }
      
      // Usar el sistema AJAX existente si está disponible
      if (typeof collection !== 'undefined' && collection.filterAjaxClick) {
        // Inicializar Shopify.queryParams si no existe
        if (typeof Shopify === 'undefined') {
          window.Shopify = {};
        }
        if (typeof Shopify.queryParams === 'undefined') {
          Shopify.queryParams = {};
        }
        
        // Limpiar parámetros anteriores
        delete Shopify.queryParams.page;
        
        if (tags.length > 0) {
          Shopify.queryParams.constraint = tags.join('+');
        } else {
          delete Shopify.queryParams.constraint;
        }
        
        // Mantener sort_by si existe
        if (currentParams.get('sort_by')) {
          Shopify.queryParams.sort_by = currentParams.get('sort_by');
        }
        
        collection.filterAjaxClick();
      } else {
        window.location.href = newUrl;
      }
    }
    
    // Función para resetear filtros
    function resetFilters() {
      const filterDropdowns = document.querySelectorAll('.filter-dropdown');
      filterDropdowns.forEach(function(dropdown) {
        if (dropdown.id !== 'filter-category') {
          dropdown.value = '';
        }
      });
      applyFilters();
    }
    
    // Exponer función de reset globalmente si es necesario
    window.resetCollectionFilters = resetFilters;
  })();
</script>

