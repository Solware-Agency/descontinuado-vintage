{% comment %}
  Filtros simplificados: 4 dropdowns horizontales
  - Categorías
  - Color
  - Talla (usando metafield custom.talla_estandar)
  - Precio
{% endcomment %}

<div class="collection-filters-simple">
  <div class="container container-v1">
    <div class="row">
      <div class="col-12">
        <div class="filters-row d-flex flex-wrap">
          
          {% comment %} Filtro de Categorías {% endcomment %}
          <div class="filter-dropdown-wrapper">
            <select class="filter-dropdown" id="filter-category" data-filter="category">
              <option value="">CATEGORÍAS</option>
              {% if settings.widget_cate_menu != blank %}
                {% for link in linklists[settings.widget_cate_menu].links %}
                  <option value="{{ link.url }}" {% if collection.url == link.url %}selected{% endif %}>
                    {{ link.title | split: '[' | first }}
                  </option>
                {% endfor %}
              {% else %}
                {% comment %} Fallback: usar todas las colecciones principales {% endcomment %}
                {% for collection_item in collections %}
                  {% unless collection_item.handle == 'all' or collection_item.handle == 'frontpage' %}
                    <option value="{{ collection_item.url }}" {% if collection.url == collection_item.url %}selected{% endif %}>
                      {{ collection_item.title }}
                    </option>
                  {% endunless %}
                {% endfor %}
              {% endif %}
            </select>
          </div>

          {% comment %} Filtro de Color - Dinámico desde productos reales {% endcomment %}
          <div class="filter-dropdown-wrapper">
            <select class="filter-dropdown" id="filter-color" data-filter="color">
              <option value="">COLOR</option>
              {% comment %} Recopilar colores únicos de los productos de la colección {% endcomment %}
              {% assign unique_colors_string = '' %}
              {% assign unique_colors_array = '' | split: ',' %}
              {% assign color_map_array = '' | split: ',' %}
              
              {% for product in collection.products %}
                {% comment %} Buscar la opción "Color" o "Colour" en las opciones del producto {% endcomment %}
                {% assign color_option_index = -1 %}
                {% for option in product.options %}
                  {% assign option_lower = option | downcase | strip %}
                  {% if option_lower == 'color' or option_lower == 'colour' or option_lower contains 'color' %}
                    {% assign color_option_index = forloop.index0 %}
                    {% break %}
                  {% endif %}
                {% endfor %}
                
                {% comment %} Si se encontró la opción de color, extraer valores de variantes {% endcomment %}
                {% if color_option_index >= 0 %}
                  {% for variant in product.variants %}
                    {% assign color_name = '' %}
                    {% if color_option_index == 0 and variant.option1 != blank %}
                      {% assign color_name = variant.option1 | strip %}
                    {% elsif color_option_index == 1 and variant.option2 != blank %}
                      {% assign color_name = variant.option2 | strip %}
                    {% elsif color_option_index == 2 and variant.option3 != blank %}
                      {% assign color_name = variant.option3 | strip %}
                    {% endif %}
                    
                    {% if color_name != blank %}
                      {% assign color_handle = color_name | handleize %}
                      {% assign color_check = '|' | append: color_handle | append: '|' %}
                      {% unless unique_colors_string contains color_check %}
                        {% assign unique_colors_string = unique_colors_string | append: color_check %}
                        {% assign unique_colors_array = unique_colors_array | push: color_handle %}
                        {% assign color_map_array = color_map_array | push: color_name %}
                      {% endunless %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
              
              {% comment %} Mostrar solo colores encontrados dinámicamente en los productos {% endcomment %}
              {% for color_handle in unique_colors_array %}
                {% assign color_index = forloop.index0 %}
                {% assign color_name = color_map_array[color_index] %}
                <option value="{{ color_handle }}" {% if current_tags contains color_handle %}selected{% endif %}>
                  {{ color_name }}
                </option>
              {% endfor %}
            </select>
          </div>

          {% comment %} Filtro de Talla (usando metafield custom.talla_estandar) {% endcomment %}
          <div class="filter-dropdown-wrapper">
            <select class="filter-dropdown" id="filter-size" data-filter="size">
              <option value="">TALLA</option>
              {% comment %} Extraer tallas desde metafield custom.talla_estandar de los productos reales {% endcomment %}
              {% assign unique_sizes_string = '' %}
              {% assign unique_sizes_array = '' | split: ',' %}
              {% assign size_map_array = '' | split: ',' %}
              
              {% for product in collection.products %}
                {% comment %} Leer metafield desde variantes primero, luego desde producto como fallback {% endcomment %}
                {% assign size_found = false %}
                {% for variant in product.variants %}
                  {% if variant.metafields.custom.talla_estandar != blank %}
                    {% assign size_value = variant.metafields.custom.talla_estandar | strip %}
                    {% if size_value != blank %}
                      {% assign size_handle = size_value | handleize %}
                      {% assign size_check = '|' | append: size_handle | append: '|' %}
                      {% unless unique_sizes_string contains size_check %}
                        {% assign unique_sizes_string = unique_sizes_string | append: size_check %}
                        {% assign unique_sizes_array = unique_sizes_array | push: size_handle %}
                        {% assign size_map_array = size_map_array | push: size_value %}
                      {% endunless %}
                      {% assign size_found = true %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                
                {% comment %} Fallback: leer desde producto si no se encontró en variantes {% endcomment %}
                {% unless size_found %}
                  {% if product.metafields.custom.talla_estandar != blank %}
                    {% assign size_value = product.metafields.custom.talla_estandar | strip %}
                    {% if size_value != blank %}
                      {% assign size_handle = size_value | handleize %}
                      {% assign size_check = '|' | append: size_handle | append: '|' %}
                      {% unless unique_sizes_string contains size_check %}
                        {% assign unique_sizes_string = unique_sizes_string | append: size_check %}
                        {% assign unique_sizes_array = unique_sizes_array | push: size_handle %}
                        {% assign size_map_array = size_map_array | push: size_value %}
                      {% endunless %}
                    {% endif %}
                  {% endif %}
                {% endunless %}
              {% endfor %}
              
              {% comment %} Mostrar solo tallas encontradas desde metafields {% endcomment %}
              {% for size_handle in unique_sizes_array %}
                {% assign size_index = forloop.index0 %}
                {% assign size_name = size_map_array[size_index] %}
                <option value="{{ size_handle }}" {% if current_tags contains size_handle %}selected{% endif %}>
                  {{ size_name }}
                </option>
              {% endfor %}
            </select>
          </div>

          {% comment %} Filtro de Precio - Rangos fijos: 0-50, 50-150, 150+ {% endcomment %}
          <div class="filter-dropdown-wrapper">
            <select class="filter-dropdown" id="filter-price" data-filter="price">
              <option value="">PRECIO</option>
              <option value="0-50" {% if current_tags contains 'price-0-50' or current_tags contains '0-50' %}selected{% endif %}>0 - 50</option>
              <option value="50-150" {% if current_tags contains 'price-50-150' or current_tags contains '50-150' %}selected{% endif %}>50 - 150</option>
              <option value="150+" {% if current_tags contains 'price-150+' or current_tags contains '150+' %}selected{% endif %}>150+</option>
            </select>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .collection-filters-simple {
    margin: 20px 0;
  padding: 0;
  }
  
  .filters-row {
    gap: 15px;
    margin-bottom: 0;
  }
  
  .filter-dropdown-wrapper {
    flex: 1;
    min-width: 150px;
  }
  
  .filter-dropdown {
    width: 100%;
    padding: 12px 40px 12px 15px;
    border: 1px solid #000;
    background: #fff;
    font-size: 14px;
    font-weight: 400;
    color: #000;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23000' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .filter-dropdown:hover {
    border-color: #333;
  }
  
  .filter-dropdown:focus {
    outline: none;
    border-color: #000;
  }
  
  /* Animaciones para filtrado */
  .product-item-wrapper {
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  
  #products-container.filtering .product-item-wrapper {
    transform: scale(0.98);
  }
  
  /* Responsive */
  @media (max-width: 991px) {
    .filters-row {
      gap: 10px;
    }
    
    .filter-dropdown-wrapper {
      flex: 0 0 calc(50% - 5px);
      min-width: calc(50% - 5px);
      max-width: calc(50% - 5px);
    }
    
    .filter-dropdown {
      font-size: 13px;
      padding: 10px 35px 10px 12px;
    }
  }
  
  @media (max-width: 575px) {
    .collection-filters-simple {
      margin: 15px 0;
    }
    
    .filters-row {
      gap: 10px;
    }
    
    .filter-dropdown-wrapper {
      flex: 0 0 100%;
      min-width: 100%;
      max-width: 100%;
    }
    
    .filter-dropdown {
      font-size: 13px;
      padding: 10px 35px 10px 12px;
    }
  }
</style>

<script>
  (function() {
    // Función helper para simular handleize de Liquid
    function handleize(str) {
      if (!str) return '';
      return str.toString()
        .toLowerCase()
        .trim()
        .replace(/[^\w\s-]/g, '') // Eliminar caracteres especiales
        .replace(/[\s_-]+/g, '-') // Reemplazar espacios, guiones bajos y guiones con un solo guion
        .replace(/^-+|-+$/g, ''); // Eliminar guiones al inicio y final
    }
    
    // Inicializar filtros cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initFilters);
    } else {
      initFilters();
    }
    
    function initFilters() {
      const filterDropdowns = document.querySelectorAll('.filter-dropdown');
      
      filterDropdowns.forEach(function(dropdown) {
        dropdown.addEventListener('change', function() {
          applyFilters();
        });
      });
      
      // Asegurar que todos los productos sean visibles inicialmente
      const productWrappers = document.querySelectorAll('.product-item-wrapper');
      productWrappers.forEach(function(wrapper) {
        wrapper.style.display = '';
        wrapper.style.opacity = '1';
      });
      
      // Restaurar valores desde URL si existen
      restoreFiltersFromURL();
    }
    
    function restoreFiltersFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      const colorFilter = document.getElementById('filter-color');
      const sizeFilter = document.getElementById('filter-size');
      const priceFilter = document.getElementById('filter-price');
      
      // Restaurar desde parámetros individuales (nuevo formato)
      const color = urlParams.get('color');
      const size = urlParams.get('size');
      const price = urlParams.get('price');
      
      if (color && colorFilter && colorFilter.querySelector('option[value="' + decodeURIComponent(color) + '"]')) {
        colorFilter.value = decodeURIComponent(color);
      }
      
      if (size && sizeFilter && sizeFilter.querySelector('option[value="' + decodeURIComponent(size) + '"]')) {
        sizeFilter.value = decodeURIComponent(size);
      }
      
      if (price && priceFilter) {
        const decodedPrice = decodeURIComponent(price);
        if (decodedPrice === '0-50' || decodedPrice === '50-150' || decodedPrice === '150+') {
          priceFilter.value = decodedPrice;
        }
      }
      
      // También soportar formato antiguo con constraint (para compatibilidad)
      const constraint = urlParams.get('constraint');
      if (constraint && (!color && !size && !price)) {
        const tags = constraint.split('+');
        tags.forEach(function(tag) {
          const decodedTag = decodeURIComponent(tag);
          
          // Manejar rangos de precio
          if (decodedTag === 'price-0-50' && priceFilter) {
            priceFilter.value = '0-50';
          } else if (decodedTag === 'price-50-150' && priceFilter) {
            priceFilter.value = '50-150';
          } else if (decodedTag === 'price-150+' && priceFilter) {
            priceFilter.value = '150+';
          }
          // Intentar asignar a filtros de color y talla
          else if (colorFilter && colorFilter.querySelector('option[value="' + decodedTag + '"]')) {
            colorFilter.value = decodedTag;
          } else if (sizeFilter && sizeFilter.querySelector('option[value="' + decodedTag + '"]')) {
            sizeFilter.value = decodedTag;
          }
        });
      }
      
      // Aplicar filtros después de restaurar
      if (color || size || price || constraint) {
        setTimeout(function() {
          applyFilters();
        }, 100);
      }
    }
    
    function applyFilters() {
      // Obtener valores de los filtros
      const categoryFilter = document.getElementById('filter-category');
      const colorFilter = document.getElementById('filter-color');
      const sizeFilter = document.getElementById('filter-size');
      const priceFilter = document.getElementById('filter-price');
      
      // Si se selecciona una categoría, redirigir limpiando filtros de la URL
      if (categoryFilter && categoryFilter.value) {
        // Limpiar parámetros de filtros de la URL antes de redirigir
        const categoryUrl = categoryFilter.value.split('?')[0]; // Obtener URL sin parámetros
        window.location.href = categoryUrl;
        return;
      }
      
      // Si se vuelve a "CATEGORÍAS" (valor vacío), resetear otros filtros
      if (categoryFilter && !categoryFilter.value) {
        if (colorFilter) colorFilter.value = '';
        if (sizeFilter) sizeFilter.value = '';
        if (priceFilter) priceFilter.value = '';
      }
      
      // Obtener valores de filtros
      const selectedColor = colorFilter ? colorFilter.value : '';
      const selectedSize = sizeFilter ? sizeFilter.value : '';
      const selectedPrice = priceFilter ? priceFilter.value : '';
      
      // Filtrar productos del lado del cliente
      const productWrappers = document.querySelectorAll('.product-item-wrapper');
      let visibleCount = 0;
      
      // Agregar clase de transición
      if (productWrappers.length > 0) {
        productWrappers[0].parentElement.classList.add('filtering');
      }
      
      productWrappers.forEach(function(wrapper) {
        let showProduct = true;
        
        // Filtro por color
        if (selectedColor && selectedColor.trim() !== '') {
          const productColors = wrapper.getAttribute('data-product-colors');
          if (productColors && productColors.trim() !== '') {
            const colors = productColors.split(',').map(function(c) { 
              return handleize(c.trim()); 
            }).filter(function(c) { return c !== ''; });
            const selectedColorHandle = handleize(selectedColor.trim());
            let colorMatch = false;
            for (let i = 0; i < colors.length; i++) {
              if (colors[i] === selectedColorHandle) {
                colorMatch = true;
                break;
              }
            }
            if (!colorMatch) {
              showProduct = false;
            }
          } else {
            showProduct = false;
          }
        }
        
        // Filtro por talla
        if (showProduct && selectedSize && selectedSize.trim() !== '') {
          const productSizes = wrapper.getAttribute('data-product-sizes');
          if (productSizes && productSizes.trim() !== '') {
            const sizes = productSizes.split(',').map(function(s) { 
              return handleize(s.trim()); 
            }).filter(function(s) { return s !== ''; });
            const selectedSizeHandle = handleize(selectedSize.trim());
            let sizeMatch = false;
            for (let i = 0; i < sizes.length; i++) {
              if (sizes[i] === selectedSizeHandle) {
                sizeMatch = true;
                break;
              }
            }
            if (!sizeMatch) {
              showProduct = false;
            }
          } else {
            showProduct = false;
          }
        }
        
        // Filtro por precio
        if (showProduct && selectedPrice && selectedPrice.trim() !== '') {
          const productPriceAttr = wrapper.getAttribute('data-product-price');
          // Limpiar el valor de posibles caracteres no numéricos y convertir a número
          let priceStr = (productPriceAttr || '0').toString();
          // Reemplazar comas por puntos para formato decimal
          priceStr = priceStr.replace(/,/g, '.');
          // Eliminar todo excepto números y punto decimal
          priceStr = priceStr.replace(/[^\d.]/g, '');
          const productPrice = parseFloat(priceStr);
          
          // Verificar que el precio sea un número válido
          if (isNaN(productPrice)) {
            showProduct = false;
          } else {
            let priceMatch = false;
            const priceValue = productPrice;
            
            if (selectedPrice === '0-50') {
              priceMatch = priceValue >= 0 && priceValue < 50;
            } else if (selectedPrice === '50-150') {
              priceMatch = priceValue >= 50 && priceValue <= 150;
            } else if (selectedPrice === '150+') {
              priceMatch = priceValue >= 150;
            }
            
            if (!priceMatch) {
              showProduct = false;
            }
          }
        }
        
        // Mostrar u ocultar producto con animación
        if (showProduct) {
          wrapper.style.display = '';
          wrapper.style.opacity = '1';
          visibleCount++;
        } else {
          wrapper.style.opacity = '0';
          setTimeout(function() {
            wrapper.style.display = 'none';
          }, 200);
        }
      });
      
      // Remover clase de transición después de animación
      setTimeout(function() {
        const container = document.getElementById('products-container');
        if (container) {
          container.classList.remove('filtering');
        }
      }, 300);
      
      // Mostrar mensaje si no hay productos
      const productsContainer = document.getElementById('products-container');
      let noResultsMsg = document.querySelector('.no-results-message');
      
      if (visibleCount === 0 && productWrappers.length > 0) {
        if (!noResultsMsg) {
          noResultsMsg = document.createElement('div');
          noResultsMsg.className = 'col-12 text-center no-results-message';
          noResultsMsg.style.padding = '40px 20px';
          noResultsMsg.innerHTML = '<p style="font-size: 16px; color: #666;">No se encontraron productos con los filtros seleccionados.</p>';
          if (productsContainer) {
            productsContainer.appendChild(noResultsMsg);
          }
        }
        noResultsMsg.style.display = 'block';
      } else if (noResultsMsg) {
        noResultsMsg.style.display = 'none';
      }
      
      // Ocultar paginación cuando hay filtros activos
      const pagination = document.querySelector('.pagi-nav');
      if (pagination) {
        if (selectedColor || selectedSize || selectedPrice) {
          pagination.style.display = 'none';
        } else {
          pagination.style.display = 'flex';
        }
      }
      
      // Actualizar URL sin recargar página
      updateURL(selectedColor, selectedSize, selectedPrice);
    }
    
    function updateURL(color, size, price) {
      const urlParams = new URLSearchParams();
      const params = [];
      
      if (color) params.push('color=' + encodeURIComponent(color));
      if (size) params.push('size=' + encodeURIComponent(size));
      if (price) params.push('price=' + encodeURIComponent(price));
      
      // Mantener sort_by si existe
      const currentParams = new URLSearchParams(window.location.search);
      if (currentParams.get('sort_by')) {
        params.push('sort_by=' + currentParams.get('sort_by'));
      }
      
      const newUrl = window.location.pathname + (params.length > 0 ? '?' + params.join('&') : '');
      window.history.replaceState({}, '', newUrl);
    }
    
    // Función para resetear filtros
    function resetFilters() {
      const filterDropdowns = document.querySelectorAll('.filter-dropdown');
      filterDropdowns.forEach(function(dropdown) {
        if (dropdown.id !== 'filter-category') {
          dropdown.value = '';
        }
      });
      applyFilters();
    }
    
    // Exponer función de reset globalmente si es necesario
    window.resetCollectionFilters = resetFilters;
  })();
</script>

